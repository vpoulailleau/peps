
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta name="color-scheme" content="light dark" />
    <title>PEP 310 – Reliable Acquisition/Release Pairs | peps.python.org</title>
    <link rel="shortcut icon" href="../_static/py.png"/>
    <link rel="canonical" href="https://peps.python.org/pep-0310.html" />
    <link rel="stylesheet" href="../_static/style.css" type="text/css" />
    <link rel="stylesheet" href="../_static/mq.css" type="text/css" />
    <link rel="stylesheet" href="../_static/dark.css" type="text/css" media="(prefers-color-scheme: dark)" id="css-dark"/>
    <link rel="stylesheet" href="../_static/pygments.css" type="text/css" media="(prefers-color-scheme: light)" id="pyg" />
    <link rel="stylesheet" href="../_static/pygments_dark.css" type="text/css" media="(prefers-color-scheme: dark)" id="pyg-dark" />
    <link href="https://fonts.googleapis.com/css2?family=Source+Sans+Pro:ital,wght@0,400;0,700;1,400&display=swap" rel="stylesheet">
    <meta name="description" content="Python Enhancement Proposals (PEPs)"/>
</head>
<body>
    <section id="pep-page-section">
        <header>
            <h1>Python Enhancement Proposals</h1>
            <ul class="breadcrumbs">
                <li><a href="https://www.python.org/" title="The Python Programming Language">Python</a> &raquo; </li>
                <li><a href="../pep-0000/">PEP Index</a> &raquo; </li>
                <li>PEP 310 – Reliable Acquisition/Release Pairs</li>
            </ul>
            <button aria-label="Toggle dark mode" onClick="toggleColourScheme()"></button>
        </header>
        <article>
            <section id="pep-content">
<h1 class="page-title">PEP 310 – Reliable Acquisition/Release Pairs</h1>
<dl class="rfc2822 field-list simple">
<dt class="field-odd">PEP</dt>
<dd class="field-odd">310</dd>
<dt class="field-even">Title</dt>
<dd class="field-even">Reliable Acquisition/Release Pairs</dd>
<dt class="field-odd">Author</dt>
<dd class="field-odd">Michael Hudson &lt;mwh&#32;&#97;t&#32;python.net&gt;,
Paul Moore &lt;p.f.moore&#32;&#97;t&#32;gmail.com&gt;</dd>
<dt class="field-even">Status</dt>
<dd class="field-even">Rejected</dd>
<dt class="field-odd">Type</dt>
<dd class="field-odd">Standards Track</dd>
<dt class="field-even">Created</dt>
<dd class="field-even">18-Dec-2002</dd>
<dt class="field-odd">Python-Version</dt>
<dd class="field-odd">2.4</dd>
<dt class="field-even">Post-History</dt>
<dd class="field-even"><p></p></dd>
</dl>
<hr class="docutils" />
<section id="contents">
<details><summary>Contents</summary><ul class="simple">
<li><a class="reference internal" href="#abstract">Abstract</a></li>
<li><a class="reference internal" href="#pronouncement">Pronouncement</a></li>
<li><a class="reference internal" href="#rationale">Rationale</a></li>
<li><a class="reference internal" href="#basic-syntax-and-semantics">Basic Syntax and Semantics</a></li>
<li><a class="reference internal" href="#possible-extensions">Possible Extensions</a><ul>
<li><a class="reference internal" href="#multiple-expressions">Multiple expressions</a></li>
<li><a class="reference internal" href="#exception-handling">Exception handling</a></li>
</ul>
</li>
<li><a class="reference internal" href="#implementation-notes">Implementation Notes</a></li>
<li><a class="reference internal" href="#open-issues">Open Issues</a></li>
<li><a class="reference internal" href="#alternative-ideas">Alternative Ideas</a></li>
<li><a class="reference internal" href="#backwards-compatibility">Backwards Compatibility</a></li>
<li><a class="reference internal" href="#cost-of-adoption">Cost of Adoption</a></li>
<li><a class="reference internal" href="#cost-of-non-adoption">Cost of Non-Adoption</a></li>
<li><a class="reference internal" href="#references">References</a></li>
<li><a class="reference internal" href="#copyright">Copyright</a></li>
</ul>
</details></section>
<section id="abstract">
<h2><a class="toc-backref" href="#abstract">Abstract</a></h2>
<p>It would be nice to have a less typing-intense way of writing:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">the_lock</span><span class="o">.</span><span class="n">acquire</span><span class="p">()</span>
<span class="k">try</span><span class="p">:</span>
    <span class="o">....</span>
<span class="k">finally</span><span class="p">:</span>
    <span class="n">the_lock</span><span class="o">.</span><span class="n">release</span><span class="p">()</span>
</pre></div>
</div>
<p>This PEP proposes a piece of syntax (a ‘with’ block) and a
“small-i” interface that generalizes the above.</p>
</section>
<section id="pronouncement">
<h2><a class="toc-backref" href="#pronouncement">Pronouncement</a></h2>
<p>This PEP is rejected in favor of <a class="pep reference internal" href="../pep-0343" title="PEP 343 – The “with” Statement">PEP 343</a>.</p>
</section>
<section id="rationale">
<h2><a class="toc-backref" href="#rationale">Rationale</a></h2>
<p>One of the advantages of Python’s exception handling philosophy is
that it makes it harder to do the “wrong” thing (e.g. failing to
check the return value of some system call).  Currently, this does
not apply to resource cleanup.  The current syntax for acquisition
and release of a resource (for example, a lock) is:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">the_lock</span><span class="o">.</span><span class="n">acquire</span><span class="p">()</span>
<span class="k">try</span><span class="p">:</span>
    <span class="o">....</span>
<span class="k">finally</span><span class="p">:</span>
    <span class="n">the_lock</span><span class="o">.</span><span class="n">release</span><span class="p">()</span>
</pre></div>
</div>
<p>This syntax separates the acquisition and release by a (possibly
large) block of code, which makes it difficult to confirm “at a
glance” that the code manages the resource correctly.  Another
common error is to code the “acquire” call within the try block,
which incorrectly releases the lock if the acquire fails.</p>
</section>
<section id="basic-syntax-and-semantics">
<h2><a class="toc-backref" href="#basic-syntax-and-semantics">Basic Syntax and Semantics</a></h2>
<p>The syntax of a ‘with’ statement is as follows:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="s1">&#39;with&#39;</span> <span class="p">[</span> <span class="n">var</span> <span class="s1">&#39;=&#39;</span> <span class="p">]</span> <span class="n">expr</span> <span class="s1">&#39;:&#39;</span>
    <span class="n">suite</span>
</pre></div>
</div>
<p>This statement is defined as being equivalent to the following
sequence of statements:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">var</span> <span class="o">=</span> <span class="n">expr</span>

<span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">var</span><span class="p">,</span> <span class="s2">&quot;__enter__&quot;</span><span class="p">):</span>
    <span class="n">var</span><span class="o">.</span><span class="fm">__enter__</span><span class="p">()</span>

<span class="k">try</span><span class="p">:</span>
    <span class="n">suite</span>

<span class="k">finally</span><span class="p">:</span>
    <span class="n">var</span><span class="o">.</span><span class="fm">__exit__</span><span class="p">()</span>
</pre></div>
</div>
<p>(The presence of an <code class="docutils literal notranslate"><span class="pre">__exit__</span></code> method is <em>not</em> checked like that of
<code class="docutils literal notranslate"><span class="pre">__enter__</span></code> to ensure that using inappropriate objects in with:
statements gives an error).</p>
<p>If the variable is omitted, an unnamed object is allocated on the
stack.  In that case, the suite has no access to the unnamed object.</p>
</section>
<section id="possible-extensions">
<h2><a class="toc-backref" href="#possible-extensions">Possible Extensions</a></h2>
<p>A number of potential extensions to the basic syntax have been
discussed on the Python Developers list.  None of these extensions
are included in the solution proposed by this PEP.  In many cases,
the arguments are nearly equally strong in both directions.  In
such cases, the PEP has always chosen simplicity, simply because
where extra power is needed, the existing try block is available.</p>
<section id="multiple-expressions">
<h3><a class="toc-backref" href="#multiple-expressions">Multiple expressions</a></h3>
<p>One proposal was for allowing multiple expressions within one
‘with’ statement.  The <code class="docutils literal notranslate"><span class="pre">__enter__</span></code> methods would be called left to
right, and the <code class="docutils literal notranslate"><span class="pre">__exit__</span></code> methods right to left.  The advantage of
doing so is that where more than one resource is being managed,
nested ‘with’ statements will result in code drifting towards the
right margin.  The solution to this problem is the same as for any
other deep nesting - factor out some of the code into a separate
function.  Furthermore, the question of what happens if one of the
<code class="docutils literal notranslate"><span class="pre">__exit__</span></code> methods raises an exception (should the other <code class="docutils literal notranslate"><span class="pre">__exit__</span></code>
methods be called?) needs to be addressed.</p>
</section>
<section id="exception-handling">
<h3><a class="toc-backref" href="#exception-handling">Exception handling</a></h3>
<p>An extension to the protocol to include an optional <code class="docutils literal notranslate"><span class="pre">__except__</span></code>
handler, which is called when an exception is raised, and which
can handle or re-raise the exception, has been suggested.  It is
not at all clear that the semantics of this extension can be made
precise and understandable.  For example, should the equivalent
code be <code class="docutils literal notranslate"><span class="pre">try</span> <span class="pre">...</span> <span class="pre">except</span> <span class="pre">...</span> <span class="pre">else</span></code> if an exception handler is
defined, and <code class="docutils literal notranslate"><span class="pre">try</span> <span class="pre">...</span> <span class="pre">finally</span></code> if not?  How can this be determined
at compile time, in general?  The alternative is to define the
code as expanding to a <code class="docutils literal notranslate"><span class="pre">try</span> <span class="pre">...</span> <span class="pre">except</span></code> inside a <code class="docutils literal notranslate"><span class="pre">try</span> <span class="pre">...</span> <span class="pre">finally</span></code>.
But this may not do the right thing in real life.</p>
<p>The only use case identified for exception handling is with
transactional processing (commit on a clean finish, and rollback
on an exception).  This is probably just as easy to handle with a
conventional <code class="docutils literal notranslate"><span class="pre">try</span> <span class="pre">...</span> <span class="pre">except</span> <span class="pre">...</span> <span class="pre">else</span></code> block, and so the PEP does
not include any support for exception handlers.</p>
</section>
</section>
<section id="implementation-notes">
<h2><a class="toc-backref" href="#implementation-notes">Implementation Notes</a></h2>
<p>There is a potential race condition in the code specified as
equivalent to the with statement.  For example, if a
<code class="docutils literal notranslate"><span class="pre">KeyboardInterrupt</span></code> exception is raised between the completion of
the <code class="docutils literal notranslate"><span class="pre">__enter__</span></code> method call and the start of the try block, the
<code class="docutils literal notranslate"><span class="pre">__exit__</span></code> method will not be called.  This can lead to resource
leaks, or to deadlocks.  [XXX Guido has stated that he cares about
this sort of race condition, and intends to write some C magic to
handle them.  The implementation of the ‘with’ statement should
copy this.]</p>
</section>
<section id="open-issues">
<h2><a class="toc-backref" href="#open-issues">Open Issues</a></h2>
<p>Should existing classes (for example, file-like objects and locks)
gain appropriate <code class="docutils literal notranslate"><span class="pre">__enter__</span></code> and <code class="docutils literal notranslate"><span class="pre">__exit__</span></code> methods?  The obvious
reason in favour is convenience (no adapter needed).  The argument
against is that if built-in files have this but (say) <code class="docutils literal notranslate"><span class="pre">StringIO</span></code>
does not, then code that uses “with” on a file object can’t be
reused with a <code class="docutils literal notranslate"><span class="pre">StringIO</span></code> object.  So <code class="docutils literal notranslate"><span class="pre">__exit__</span> <span class="pre">=</span> <span class="pre">close</span></code> becomes a part
of the “file-like object” protocol, which user-defined classes may
need to support.</p>
<p>The <code class="docutils literal notranslate"><span class="pre">__enter__</span></code> hook may be unnecessary - for many use cases, an
adapter class is needed and in that case, the work done by the
<code class="docutils literal notranslate"><span class="pre">__enter__</span></code> hook can just as easily be done in the <code class="docutils literal notranslate"><span class="pre">__init__</span></code> hook.</p>
<p>If a way of controlling object lifetimes explicitly was available,
the function of the <code class="docutils literal notranslate"><span class="pre">__exit__</span></code> hook could be taken over by the
existing <code class="docutils literal notranslate"><span class="pre">__del__</span></code> hook.  An email exchange <a class="footnote-reference brackets" href="#id4" id="id1">[1]</a> with a proponent of
this approach left one of the authors even more convinced that
it isn’t the right idea…</p>
<p>It has been suggested <a class="footnote-reference brackets" href="#id5" id="id2">[2]</a> that the “__exit__” method be called
“close”, or that a “close” method should be considered if no
<code class="docutils literal notranslate"><span class="pre">__exit__</span></code> method is found, to increase the “out-of-the-box utility”
of the “with …” construct.</p>
<p>There are some similarities in concept between ‘with …’ blocks
and generators, which have led to proposals that for loops could
implement the with block functionality <a class="footnote-reference brackets" href="#id6" id="id3">[3]</a>.  While neat on some
levels, we think that for loops should stick to being loops.</p>
</section>
<section id="alternative-ideas">
<h2><a class="toc-backref" href="#alternative-ideas">Alternative Ideas</a></h2>
<p>IEXEC: Holger Krekel – generalised approach with XML-like syntax
(no URL found…).</p>
<p>Holger has much more far-reaching ideas about “execution monitors”
that are informed about details of control flow in the monitored
block.  While interesting, these ideas could change the language
in deep and subtle ways and as such belong to a different PEP.</p>
<p>Any Smalltalk/Ruby anonymous block style extension obviously
subsumes this one.</p>
<p><a class="pep reference internal" href="../pep-0319" title="PEP 319 – Python Synchronize/Asynchronize Block">PEP 319</a> is in the same area, but did not win support when aired on
python-dev.</p>
</section>
<section id="backwards-compatibility">
<h2><a class="toc-backref" href="#backwards-compatibility">Backwards Compatibility</a></h2>
<p>This PEP proposes a new keyword, so the <code class="docutils literal notranslate"><span class="pre">__future__</span></code> game will need
to be played.</p>
</section>
<section id="cost-of-adoption">
<h2><a class="toc-backref" href="#cost-of-adoption">Cost of Adoption</a></h2>
<p>Those who claim the language is getting larger and more
complicated have something else to complain about.  It’s something
else to teach.</p>
<p>For the proposal to be useful, many file-like and lock-like
classes in the standard library and other code will have to have</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="fm">__exit__</span> <span class="o">=</span> <span class="n">close</span>
</pre></div>
</div>
<p>or similar added.</p>
</section>
<section id="cost-of-non-adoption">
<h2><a class="toc-backref" href="#cost-of-non-adoption">Cost of Non-Adoption</a></h2>
<p>Writing correct code continues to be more effort than writing
incorrect code.</p>
</section>
<section id="references">
<h2><a class="toc-backref" href="#references">References</a></h2>
<p>There are various python-list and python-dev discussions that
could be mentioned here.</p>
<dl class="footnote brackets">
<dt class="label" id="id4">[<a href="#id1">1</a>]</dt>
<dd>Off-list conversation between Michael Hudson and Bill Soudan
(made public with permission)
<a class="reference external" href="http://starship.python.net/crew/mwh/pep310/">http://starship.python.net/crew/mwh/pep310/</a></dd>
<dt class="label" id="id5">[<a href="#id2">2</a>]</dt>
<dd>Samuele Pedroni on python-dev
<a class="reference external" href="https://mail.python.org/pipermail/python-dev/2003-August/037795.html">https://mail.python.org/pipermail/python-dev/2003-August/037795.html</a></dd>
<dt class="label" id="id6">[<a href="#id3">3</a>]</dt>
<dd>Thread on python-dev with subject
<cite>[Python-Dev] pre-PEP: Resource-Release Support for Generators</cite>
starting at
<a class="reference external" href="https://mail.python.org/pipermail/python-dev/2003-August/037803.html">https://mail.python.org/pipermail/python-dev/2003-August/037803.html</a></dd>
</dl>
</section>
<section id="copyright">
<h2><a class="toc-backref" href="#copyright">Copyright</a></h2>
<p>This document has been placed in the public domain.</p>
</section>
</section>
<hr class="docutils" />
<p>Source: <a class="reference external" href="https://github.com/python/peps/blob/main/pep-0310.txt">https://github.com/python/peps/blob/main/pep-0310.txt</a></p>
<p>Last modified: <a class="reference external" href="https://github.com/python/peps/commits/main/pep-0310.txt">2022-01-21 11:03:51 GMT</a></p>

        </article>
        <nav id="pep-sidebar">
            <h2>Contents</h2>
            <p id="toc-title">PEP 310 – Reliable Acquisition/Release Pairs</p>
            <ul>
<li><a class="reference internal" href="#abstract">Abstract</a></li>
<li><a class="reference internal" href="#pronouncement">Pronouncement</a></li>
<li><a class="reference internal" href="#rationale">Rationale</a></li>
<li><a class="reference internal" href="#basic-syntax-and-semantics">Basic Syntax and Semantics</a></li>
<li><a class="reference internal" href="#possible-extensions">Possible Extensions</a><ul>
<li><a class="reference internal" href="#multiple-expressions">Multiple expressions</a></li>
<li><a class="reference internal" href="#exception-handling">Exception handling</a></li>
</ul>
</li>
<li><a class="reference internal" href="#implementation-notes">Implementation Notes</a></li>
<li><a class="reference internal" href="#open-issues">Open Issues</a></li>
<li><a class="reference internal" href="#alternative-ideas">Alternative Ideas</a></li>
<li><a class="reference internal" href="#backwards-compatibility">Backwards Compatibility</a></li>
<li><a class="reference internal" href="#cost-of-adoption">Cost of Adoption</a></li>
<li><a class="reference internal" href="#cost-of-non-adoption">Cost of Non-Adoption</a></li>
<li><a class="reference internal" href="#references">References</a></li>
<li><a class="reference internal" href="#copyright">Copyright</a></li>
</ul>

            <br />
            <a id="source" href="https://github.com/python/peps/blob/main/pep-0310.txt">Page Source (GitHub)</a>
        </nav>
    </section>
    <script src="../_static/colour_scheme.js"></script>
    <script src="../_static/wrap_tables.js"></script>
</body>
</html>