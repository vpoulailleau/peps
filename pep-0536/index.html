
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta name="color-scheme" content="light dark" />
    <title>PEP 536 – Final Grammar for Literal String Interpolation | peps.python.org</title>
    <link rel="shortcut icon" href="../_static/py.png"/>
    <link rel="canonical" href="https://peps.python.org/pep-0536.html" />
    <link rel="stylesheet" href="../_static/style.css" type="text/css" />
    <link rel="stylesheet" href="../_static/mq.css" type="text/css" />
    <link rel="stylesheet" href="../_static/dark.css" type="text/css" media="(prefers-color-scheme: dark)" id="css-dark"/>
    <link rel="stylesheet" href="../_static/pygments.css" type="text/css" media="(prefers-color-scheme: light)" id="pyg" />
    <link rel="stylesheet" href="../_static/pygments_dark.css" type="text/css" media="(prefers-color-scheme: dark)" id="pyg-dark" />
    <link href="https://fonts.googleapis.com/css2?family=Source+Sans+Pro:ital,wght@0,400;0,700;1,400&display=swap" rel="stylesheet">
    <meta name="description" content="Python Enhancement Proposals (PEPs)"/>
</head>
<body>
    <section id="pep-page-section">
        <header>
            <h1>Python Enhancement Proposals</h1>
            <ul class="breadcrumbs">
                <li><a href="https://www.python.org/" title="The Python Programming Language">Python</a> &raquo; </li>
                <li><a href="../pep-0000/">PEP Index</a> &raquo; </li>
                <li>PEP 536 – Final Grammar for Literal String Interpolation</li>
            </ul>
            <button aria-label="Toggle dark mode" onClick="toggleColourScheme()"></button>
        </header>
        <article>
            <section id="pep-content">
<h1 class="page-title">PEP 536 – Final Grammar for Literal String Interpolation</h1>
<dl class="rfc2822 field-list simple">
<dt class="field-odd">PEP</dt>
<dd class="field-odd">536</dd>
<dt class="field-even">Title</dt>
<dd class="field-even">Final Grammar for Literal String Interpolation</dd>
<dt class="field-odd">Author</dt>
<dd class="field-odd">Philipp Angerer &lt;phil.angerer&#32;&#97;t&#32;gmail.com&gt;</dd>
<dt class="field-even">Status</dt>
<dd class="field-even">Deferred</dd>
<dt class="field-odd">Type</dt>
<dd class="field-odd">Standards Track</dd>
<dt class="field-even">Created</dt>
<dd class="field-even">11-Dec-2016</dd>
<dt class="field-odd">Python-Version</dt>
<dd class="field-odd">3.7</dd>
<dt class="field-even">Post-History</dt>
<dd class="field-even">12-Dec-2016</dd>
</dl>
<hr class="docutils" />
<section id="contents">
<details><summary>Contents</summary><ul class="simple">
<li><a class="reference internal" href="#abstract">Abstract</a></li>
<li><a class="reference internal" href="#pep-status">PEP Status</a></li>
<li><a class="reference internal" href="#terminology">Terminology</a></li>
<li><a class="reference internal" href="#motivation">Motivation</a></li>
<li><a class="reference internal" href="#rationale">Rationale</a></li>
<li><a class="reference internal" href="#specification">Specification</a></li>
<li><a class="reference internal" href="#backwards-compatibility">Backwards Compatibility</a></li>
<li><a class="reference internal" href="#reference-implementation">Reference Implementation</a></li>
<li><a class="reference internal" href="#references">References</a></li>
<li><a class="reference internal" href="#copyright">Copyright</a></li>
</ul>
</details></section>
<section id="abstract">
<h2><a class="toc-backref" href="#abstract">Abstract</a></h2>
<p><a class="pep reference internal" href="../pep-0498" title="PEP 498 – Literal String Interpolation">PEP 498</a> introduced Literal String Interpolation (or “f-strings”).
The expression portions of those literals however are subject to
certain restrictions.  This PEP proposes a formal grammar lifting
those restrictions, promoting “f-strings” to “f expressions” or f-literals.</p>
<p>This PEP expands upon the f-strings introduced by <a class="pep reference internal" href="../pep-0498" title="PEP 498 – Literal String Interpolation">PEP 498</a>,
so this text requires familiarity with <a class="pep reference internal" href="../pep-0498" title="PEP 498 – Literal String Interpolation">PEP 498</a>.</p>
</section>
<section id="pep-status">
<h2><a class="toc-backref" href="#pep-status">PEP Status</a></h2>
<p>This PEP is deferred until an implementation is available.</p>
</section>
<section id="terminology">
<h2><a class="toc-backref" href="#terminology">Terminology</a></h2>
<p>This text will refer to the existing grammar as “f-strings”,
and the proposed one as “f-literals”.</p>
<p>Furthermore, it will refer to the <code class="docutils literal notranslate"><span class="pre">{}</span></code>-delimited expressions in
f-literals/f-strings as “expression portions” and the static string content
around them as “string portions”.</p>
</section>
<section id="motivation">
<h2><a class="toc-backref" href="#motivation">Motivation</a></h2>
<p>The current implementation of f-strings in CPython relies on the existing
string parsing machinery and a post processing of its tokens.  This results in
several restrictions to the possible expressions usable within f-strings:</p>
<ol class="arabic">
<li>It is impossible to use the quote character delimiting the f-string
within the expression portion:<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="sa">f</span><span class="s1">&#39;Magic wand: </span><span class="si">{</span> <span class="n">bag</span><span class="p">[</span><span class="s1">&#39;wand&#39;</span><span class="p">]</span> <span class="si">}</span><span class="s1">&#39;</span>
<span class="go">                             ^</span>
<span class="go">SyntaxError: invalid syntax</span>
</pre></div>
</div>
</li>
<li>A previously considered way around it would lead to escape sequences
in executed code and is prohibited in f-strings:<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>&gt;&gt;&gt; f&#39;Magic wand { bag[\&#39;wand\&#39;] } string&#39;
SyntaxError: f-string expression portion cannot include a backslash
</pre></div>
</div>
</li>
<li>Comments are forbidden even in multi-line f-strings:<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>&gt;&gt;&gt; f&#39;&#39;&#39;A complex trick: {
... bag[&#39;bag&#39;]  # recursive bags!
... }&#39;&#39;&#39;
SyntaxError: f-string expression part cannot include &#39;#&#39;
</pre></div>
</div>
</li>
<li>Expression portions need to wrap <code class="docutils literal notranslate"><span class="pre">':'</span></code> and <code class="docutils literal notranslate"><span class="pre">'!'</span></code> in braces:<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="sa">f</span><span class="s1">&#39;Useless use of lambdas: </span><span class="si">{</span> <span class="k">lambda</span> <span class="n">x</span><span class="si">:</span><span class="s1"> x*2 </span><span class="si">}</span><span class="s1">&#39;</span>
<span class="go">SyntaxError: unexpected EOF while parsing</span>
</pre></div>
</div>
</li>
</ol>
<p>These limitations serve no purpose from a language user perspective and
can be lifted by giving f-literals a regular grammar without exceptions
and implementing it using dedicated parse code.</p>
</section>
<section id="rationale">
<h2><a class="toc-backref" href="#rationale">Rationale</a></h2>
<p>The restrictions mentioned in <a class="reference internal" href="#motivation">Motivation</a> are non-obvious and counter-intuitive
unless the user is familiar with the f-literals’ implementation details.</p>
<p>As mentioned, a previous version of <a class="pep reference internal" href="../pep-0498" title="PEP 498 – Literal String Interpolation">PEP 498</a> allowed escape sequences
anywhere in f-strings, including as ways to encode the braces delimiting
the expression portions and in their code.  They would be expanded before
the code is parsed, which would have had several important ramifications:</p>
<p>#. It would not be clear to human readers which portions are Expressions
and which are strings.  Great material for an “obfuscated/underhanded
Python challenge”
#. Syntax highlighters are good in parsing nested grammar, but not
in recognizing escape sequences.  ECMAScript 2016 (JavaScript) allows
escape sequences in its identifiers <a class="footnote-reference brackets" href="#id3" id="id1">[1]</a> and the author knows of no
syntax highlighter able to correctly highlight code making use of this.</p>
<p>As a consequence, the expression portions would be harder to recognize
with and without the aid of syntax highlighting.  With the new grammar,
it is easy to extend syntax highlighters to correctly parse
and display f-literals:</p>
<pre><span style=color:#ff5500>f'Magic wand: </span><span style=color:#3daee9>{</span>bag[<span style=color:#bf0303>'wand'</span>]<span style=color:#3daee9>:^10}</span><span style=color:#ff5500>'</span></pre><p>Highlighting expression portions with possible escape sequences would
mean to create a modified copy of all rules of the complete expression
grammar, accounting for the possibility of escape sequences in key words,
delimiters, and all other language syntax. One such duplication would
yield one level of escaping depth and have to be repeated for a deeper
escaping in a recursive f-literal. This is the case since no highlighting
engine known to the author supports expanding escape sequences before
applying rules to a certain context. Nesting contexts however is a
standard feature of all highlighting engines.</p>
<p>Familiarity also plays a role: Arbitrary nesting of expressions
without expansion of escape sequences is available in every single
other language employing a string interpolation method that uses
expressions instead of just variable names. <a class="footnote-reference brackets" href="#id4" id="id2">[2]</a></p>
</section>
<section id="specification">
<h2><a class="toc-backref" href="#specification">Specification</a></h2>
<p><a class="pep reference internal" href="../pep-0498" title="PEP 498 – Literal String Interpolation">PEP 498</a> specified f-strings as the following, but places restrictions on it:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">f</span> <span class="s1">&#39; &lt;text&gt; { &lt;expression&gt; &lt;optional !s, !r, or !a&gt; &lt;optional : format specifier&gt; } &lt;text&gt; ... &#39;</span>
</pre></div>
</div>
<p>All restrictions mentioned in the PEP are lifted from f-literals,
as explained below:</p>
<ol class="arabic simple">
<li>Expression portions may now contain strings delimited with the same
kind of quote that is used to delimit the f-literal.</li>
<li>Backslashes may now appear within expressions just like anywhere else
in Python code.  In case of strings nested within f-literals,
escape sequences are expanded when the innermost string is evaluated.</li>
<li>Comments, using the <code class="docutils literal notranslate"><span class="pre">'#'</span></code> character, are possible only in multi-line
f-literals, since comments are terminated by the end of the line
(which makes closing a single-line f-literal impossible).</li>
<li>Expression portions may contain <code class="docutils literal notranslate"><span class="pre">':'</span></code> or <code class="docutils literal notranslate"><span class="pre">'!'</span></code> wherever
syntactically valid.  The first <code class="docutils literal notranslate"><span class="pre">':'</span></code> or <code class="docutils literal notranslate"><span class="pre">'!'</span></code> that is not part
of an expression has to be followed a valid coercion or format specifier.</li>
</ol>
<p>A remaining restriction not explicitly mentioned by <a class="pep reference internal" href="../pep-0498" title="PEP 498 – Literal String Interpolation">PEP 498</a> is line breaks
in expression portions.  Since strings delimited by single <code class="docutils literal notranslate"><span class="pre">'</span></code> or <code class="docutils literal notranslate"><span class="pre">&quot;</span></code>
characters are expected to be single line, line breaks remain illegal
in expression portions of single line strings.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>Is lifting of the restrictions sufficient,
or should we specify a more complete grammar?</p>
</div>
</section>
<section id="backwards-compatibility">
<h2><a class="toc-backref" href="#backwards-compatibility">Backwards Compatibility</a></h2>
<p>f-literals are fully backwards compatible to f-strings,
and expands the syntax considered legal.</p>
</section>
<section id="reference-implementation">
<h2><a class="toc-backref" href="#reference-implementation">Reference Implementation</a></h2>
<p>TBD</p>
</section>
<section id="references">
<h2><a class="toc-backref" href="#references">References</a></h2>
<dl class="footnote brackets">
<dt class="label" id="id3">[<a href="#id1">1</a>]</dt>
<dd>ECMAScript <code class="docutils literal notranslate"><span class="pre">IdentifierName</span></code> specification
( <a class="reference external" href="http://ecma-international.org/ecma-262/6.0/#sec-names-and-keywords">http://ecma-international.org/ecma-262/6.0/#sec-names-and-keywords</a> )<p>Yes, <code class="docutils literal notranslate"><span class="pre">const</span> <span class="pre">cthulhu</span> <span class="pre">=</span> <span class="pre">{</span> <span class="pre">H̹̙̦̮͉̩̗̗ͧ̇̏̊̾Eͨ͆͒̆ͮ̃͏̷̮̣̫̤̣Cͯ̂͐͏̨̛͔̦̟͈̻O̜͎͍͙͚̬̝̣̽ͮ͐͗̀ͤ̍̀͢M̴̡̲̭͍͇̼̟̯̦̉̒͠Ḛ̛̙̞̪̗ͥͤͩ̾͑̔͐ͅṮ̴̷̷̗̼͍̿̿̓̽͐H̙̙̔̄͜\u0042:</span> <span class="pre">42</span> <span class="pre">}</span></code> is valid ECMAScript 2016</p>
</dd>
<dt class="label" id="id4">[<a href="#id2">2</a>]</dt>
<dd>Wikipedia article on string interpolation
( <a class="reference external" href="https://en.wikipedia.org/wiki/String_interpolation">https://en.wikipedia.org/wiki/String_interpolation</a> )</dd>
</dl>
</section>
<section id="copyright">
<h2><a class="toc-backref" href="#copyright">Copyright</a></h2>
<p>This document has been placed in the public domain.</p>
</section>
</section>
<hr class="docutils" />
<p>Source: <a class="reference external" href="https://github.com/python/peps/blob/main/pep-0536.txt">https://github.com/python/peps/blob/main/pep-0536.txt</a></p>
<p>Last modified: <a class="reference external" href="https://github.com/python/peps/commits/main/pep-0536.txt">2022-01-21 11:03:51 GMT</a></p>

        </article>
        <nav id="pep-sidebar">
            <h2>Contents</h2>
            <p id="toc-title">PEP 536 – Final Grammar for Literal String Interpolation</p>
            <ul>
<li><a class="reference internal" href="#abstract">Abstract</a></li>
<li><a class="reference internal" href="#pep-status">PEP Status</a></li>
<li><a class="reference internal" href="#terminology">Terminology</a></li>
<li><a class="reference internal" href="#motivation">Motivation</a></li>
<li><a class="reference internal" href="#rationale">Rationale</a></li>
<li><a class="reference internal" href="#specification">Specification</a></li>
<li><a class="reference internal" href="#backwards-compatibility">Backwards Compatibility</a></li>
<li><a class="reference internal" href="#reference-implementation">Reference Implementation</a></li>
<li><a class="reference internal" href="#references">References</a></li>
<li><a class="reference internal" href="#copyright">Copyright</a></li>
</ul>

            <br />
            <a id="source" href="https://github.com/python/peps/blob/main/pep-0536.txt">Page Source (GitHub)</a>
        </nav>
    </section>
    <script src="../_static/colour_scheme.js"></script>
    <script src="../_static/wrap_tables.js"></script>
</body>
</html>