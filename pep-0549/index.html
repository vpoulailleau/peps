
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta name="color-scheme" content="light dark" />
    <title>PEP 549 – Instance Descriptors | peps.python.org</title>
    <link rel="shortcut icon" href="../_static/py.png"/>
    <link rel="canonical" href="https://peps.python.org/pep-0549.html" />
    <link rel="stylesheet" href="../_static/style.css" type="text/css" />
    <link rel="stylesheet" href="../_static/mq.css" type="text/css" />
    <link rel="stylesheet" href="../_static/dark.css" type="text/css" media="(prefers-color-scheme: dark)" id="css-dark"/>
    <link rel="stylesheet" href="../_static/pygments.css" type="text/css" media="(prefers-color-scheme: light)" id="pyg" />
    <link rel="stylesheet" href="../_static/pygments_dark.css" type="text/css" media="(prefers-color-scheme: dark)" id="pyg-dark" />
    <link href="https://fonts.googleapis.com/css2?family=Source+Sans+Pro:ital,wght@0,400;0,700;1,400&display=swap" rel="stylesheet">
    <meta name="description" content="Python Enhancement Proposals (PEPs)"/>
</head>
<body>
    <section id="pep-page-section">
        <header>
            <h1>Python Enhancement Proposals</h1>
            <ul class="breadcrumbs">
                <li><a href="https://www.python.org/" title="The Python Programming Language">Python</a> &raquo; </li>
                <li><a href="../pep-0000/">PEP Index</a> &raquo; </li>
                <li>PEP 549 – Instance Descriptors</li>
            </ul>
            <button aria-label="Toggle dark mode" onClick="toggleColourScheme()"></button>
        </header>
        <article>
            <section id="pep-content">
<h1 class="page-title">PEP 549 – Instance Descriptors</h1>
<dl class="rfc2822 field-list simple">
<dt class="field-odd">PEP</dt>
<dd class="field-odd">549</dd>
<dt class="field-even">Title</dt>
<dd class="field-even">Instance Descriptors</dd>
<dt class="field-odd">Author</dt>
<dd class="field-odd">larry&#32;&#97;t&#32;hastings.org (Larry Hastings)</dd>
<dt class="field-even">Discussions-To</dt>
<dd class="field-even"><a class="reference external" href="mailto:python-dev&#37;&#52;&#48;python&#46;org">python-dev<span>&#64;</span>python<span>&#46;</span>org</a></dd>
<dt class="field-odd">Status</dt>
<dd class="field-odd">Rejected</dd>
<dt class="field-even">Type</dt>
<dd class="field-even">Standards Track</dd>
<dt class="field-odd">Created</dt>
<dd class="field-odd">04-Sep-2017</dd>
<dt class="field-even">Python-Version</dt>
<dd class="field-even">3.7</dd>
<dt class="field-odd">Post-History</dt>
<dd class="field-odd">04-Sep-2017</dd>
</dl>
<hr class="docutils" />
<section id="contents">
<details><summary>Contents</summary><ul class="simple">
<li><a class="reference internal" href="#rejection-notice">Rejection Notice</a></li>
<li><a class="reference internal" href="#abstract">Abstract</a></li>
<li><a class="reference internal" href="#rationale">Rationale</a></li>
<li><a class="reference internal" href="#implementation">Implementation</a></li>
<li><a class="reference internal" href="#prototype">Prototype</a></li>
<li><a class="reference internal" href="#acknowledgements">Acknowledgements</a></li>
<li><a class="reference internal" href="#references">References</a><ul>
<li><a class="reference internal" href="#copyright">Copyright</a></li>
</ul>
</li>
</ul>
</details></section>
<section id="rejection-notice">
<h2><a class="toc-backref" href="#rejection-notice">Rejection Notice</a></h2>
<p><a class="reference external" href="https://mail.python.org/pipermail/python-dev/2017-November/150528.html">https://mail.python.org/pipermail/python-dev/2017-November/150528.html</a></p>
</section>
<section id="abstract">
<h2><a class="toc-backref" href="#abstract">Abstract</a></h2>
<p>Python’s descriptor protocol requires that descriptors
be members of the <em>type</em> of an object.  This PEP proposes
an extension to the descriptor protocol allowing use of
the descriptor protocol for members of <em>instances.</em>  This
would permit using properties in modules.</p>
</section>
<section id="rationale">
<h2><a class="toc-backref" href="#rationale">Rationale</a></h2>
<p>Python’s descriptor protocol guides programmers towards
elegant API design.  If your class supports a data-like
member, and you <em>might</em> someday need to run code when
changing the member’s value, you’re encouraged to
simply declare it as a simple data member of the class
for now.  If in the future you do need to run code, you
can change it to a “property”, and happily the API doesn’t
change.</p>
<p>But consider this second bit of best-practice Python API design:
if you’re writing a singleton, don’t write a class, just build
your code directly into a module.  Don’t make your users
instantiate a singleton class, don’t make your users have to
dereference through a singleton object stored in a module,
just have module-level functions and module-level data.</p>
<p>Unfortunately these two best practices are in opposition.
The problem is that properties aren’t supported on modules.
Modules are instances of a single generic <code class="docutils literal notranslate"><span class="pre">module</span></code> type,
and it’s not feasible to modify or subclass this type to add
a property to one’s module.  This means that programmers
facing this API design decision, where the data-like member
is a singleton stored in a module, must preemptively add
ugly “getters” and “setters” for the data.</p>
<p>Adding support for module properties in pure Python has recently
become <em>possible;</em>
as of Python 3.5, Python permits assigning to the <code class="docutils literal notranslate"><span class="pre">__class__</span></code>
attribute of module objects, specifically for this purpose.  Here’s
an example of using this functionality to add a property to a module:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">sys</span><span class="o">,</span> <span class="nn">types</span>
<span class="k">class</span> <span class="nc">_MyModuleType</span><span class="p">(</span><span class="n">types</span><span class="o">.</span><span class="n">ModuleType</span><span class="p">):</span>
    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">prop</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">instance</span><span class="p">,</span> <span class="n">owner</span><span class="p">):</span>
        <span class="o">...</span>

<span class="n">sys</span><span class="o">.</span><span class="n">modules</span><span class="p">[</span><span class="vm">__name__</span><span class="p">]</span><span class="o">.</span><span class="vm">__class__</span> <span class="o">=</span> <span class="n">_MyModuleType</span>
</pre></div>
</div>
<p>This works, and is supported behavior, but it’s clumsy and obscure.</p>
<p>This PEP proposes a per-type opt-in extension to the descriptor
protocol specifically designed to enable properties in modules.
The mechanism is a way to honor the descriptor protocol for
members of <em>instances</em> of a class without the member being declared
as a class variable.</p>
<p>Although this is being proposed as a general mechanism, the author
currently only foresees this as being useful for module objects.</p>
</section>
<section id="implementation">
<h2><a class="toc-backref" href="#implementation">Implementation</a></h2>
<p>The basic idea is simple: modify the <code class="docutils literal notranslate"><span class="pre">tp_descr_get</span></code> and <code class="docutils literal notranslate"><span class="pre">tp_descr_set</span></code>
functions exposed by <code class="docutils literal notranslate"><span class="pre">PyModule_Type</span></code> to inspect the attribute interacted
with, and if it supports the descriptor protocol, call the relevant
exposed function.</p>
<p>Our implementation faces two challenges:</p>
<ol class="arabic simple">
<li>Since this code will be run every time an attribute is looked up on a
method, it needs to add very little overhead in the general case,
where the object stored in the attribute is not a descriptor.</li>
<li>Since functions are descriptors, we must take care to <em>not</em> honor
the descriptor protocol for all objects.  Otherwise, all module-level
functions will suddenly become bound to the module instance as if
they were method calls on the module object.  The module handle would
be passed in as a “self” argument to all module-level functions.</li>
</ol>
<p>Both challenges can be solved with the same approach: we define a new
“fast subclass” flag that means “This object is a descriptor, and it
should be honored directly when this object is looked up as an
attribute of an instance”.  So far this flag is only set on two
types: <code class="docutils literal notranslate"><span class="pre">property</span></code> and <code class="docutils literal notranslate"><span class="pre">collections.abc.InstanceDescriptor</span></code>.
The latter is an abstract base class, whose only purpose is
to allow user classes to inherit this “fast subclass” flag.</p>
</section>
<section id="prototype">
<h2><a class="toc-backref" href="#prototype">Prototype</a></h2>
<p>A prototype of this functionality is under development
at GitHub <a class="reference internal" href="../pep-0484/#github" id="id1"><span>[github]</span></a>.</p>
</section>
<section id="acknowledgements">
<h2><a class="toc-backref" href="#acknowledgements">Acknowledgements</a></h2>
<p>Armin Rigo essentially proposed this mechanism when presented
with the idea of “module properties”, and educated the author
both on the complexities of the problem and the proper solution.
Nathaniel J. Smith pointed out the 3.5 extension about assigning
to <code class="docutils literal notranslate"><span class="pre">__class__</span></code> on module objects, and provided the example.</p>
</section>
<section id="references">
<h2><a class="toc-backref" href="#references">References</a></h2>
<dl class="citation">
<dt class="label" id="github">[<a href="#id1">github</a>]</dt>
<dd><dl class="simple">
<dt>The branch is here:</dt><dd><a class="reference external" href="https://github.com/larryhastings/cpython/tree/module-properties">https://github.com/larryhastings/cpython/tree/module-properties</a></dd>
<dt>A pull request against the main CPython repo is here:</dt><dd><a class="reference external" href="https://github.com/python/cpython/pull/3534">https://github.com/python/cpython/pull/3534</a></dd>
</dl>
</dd>
</dl>
<section id="copyright">
<h3><a class="toc-backref" href="#copyright">Copyright</a></h3>
<p>This document has been placed in the public domain.</p>
</section>
</section>
</section>
<hr class="docutils" />
<p>Source: <a class="reference external" href="https://github.com/python/peps/blob/main/pep-0549.rst">https://github.com/python/peps/blob/main/pep-0549.rst</a></p>
<p>Last modified: <a class="reference external" href="https://github.com/python/peps/commits/main/pep-0549.rst">2022-03-09 16:04:44 GMT</a></p>

        </article>
        <nav id="pep-sidebar">
            <h2>Contents</h2>
            <p id="toc-title">PEP 549 – Instance Descriptors</p>
            <ul>
<li><a class="reference internal" href="#rejection-notice">Rejection Notice</a></li>
<li><a class="reference internal" href="#abstract">Abstract</a></li>
<li><a class="reference internal" href="#rationale">Rationale</a></li>
<li><a class="reference internal" href="#implementation">Implementation</a></li>
<li><a class="reference internal" href="#prototype">Prototype</a></li>
<li><a class="reference internal" href="#acknowledgements">Acknowledgements</a></li>
<li><a class="reference internal" href="#references">References</a><ul>
<li><a class="reference internal" href="#copyright">Copyright</a></li>
</ul>
</li>
</ul>

            <br />
            <a id="source" href="https://github.com/python/peps/blob/main/pep-0549.rst">Page Source (GitHub)</a>
        </nav>
    </section>
    <script src="../_static/colour_scheme.js"></script>
    <script src="../_static/wrap_tables.js"></script>
</body>
</html>